# Resolve react_native_pods.rb with node to allow for hoisting, with CI fallback
begin
  require Pod::Executable.execute_command('node', ['-p',
    'require.resolve(
      "react-native/scripts/react_native_pods.rb",
      {paths: [process.argv[1]]},
    )', __dir__]).strip
rescue => e
  fallback = File.expand_path('../node_modules/react-native/scripts/react_native_pods.rb', __dir__)
  if File.exist?(fallback)
    Pod::UI.puts "[Podfile] Node resolve failed (#{e.class}: #{e.message}). Using fallback path: #{fallback}".yellow
    require fallback
  else
    Pod::UI.warn "[Podfile] Could not resolve react_native_pods.rb via Node or fallback. Ensure Node is available before 'pod install' (e.g., run ci_scripts/ci_post_clone.sh)."
    raise
  end
end
require 'fileutils'

platform :ios, '16.0'
# Pin Firebase iOS SDK to 11.8.0+ where FIRActionCodeSettings.setLinkDomain is available
$FirebaseSDKVersion = '11.8.0'
use_modular_headers!
prepare_react_native_project!

# Silence CocoaPods master specs repo warning (CDN is default)
install! 'cocoapods', :warn_for_unused_master_specs_repo => false


use_frameworks! :linkage => :static


target 'iLeafU' do
  config = use_native_modules!

  use_react_native!(
    :path => config[:reactNativePath],
    # An absolute path to your application root.
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  # Firebase pods - let @react-native-firebase modules determine compatible versions
  # Removed explicit version constraints to avoid conflicts with RNFB requirements

  target 'iLeafUTests' do
    inherit! :complete
    # Pods for testing
  end

  post_install do |installer|
    # https://github.com/facebook/react-native/blob/main/packages/react-native/scripts/react_native_pods.rb#L197-L202
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false,
      # :ccache_enabled => true
    )

    # Workaround: Some toolchains look for gRPC modulemap at Headers/Private/grpc/gRPC-Core.modulemap.
    # CocoaPods 1.15+ places modulemaps under Target Support Files. Copy it to the expected location.
    begin
      pods_root = installer.sandbox.root
      modulemap_src = File.join(pods_root, 'Target Support Files', 'gRPC-Core', 'gRPC-Core.modulemap')
      if File.exist?(modulemap_src)
        [
          File.join(pods_root, 'Headers', 'Private', 'grpc'),
          File.join(pods_root, 'Headers', 'Public', 'grpc')
        ].each do |dest_dir|
          FileUtils.mkdir_p(dest_dir) unless File.directory?(dest_dir)
          dest_path = File.join(dest_dir, 'gRPC-Core.modulemap')
          FileUtils.cp(modulemap_src, dest_path) unless File.exist?(dest_path)
        end
      end
    rescue => e
      Pod::UI.warn("[post_install] gRPC modulemap copy failed: #{e.message}")
    end

    # Note: Do NOT set FIREBASE_BUILD_WITHOUT_SWIFT. FirebaseStorage v10 exposes Obj-C APIs
    # via a generated Swift compatibility header. Defining FIREBASE_BUILD_WITHOUT_SWIFT prevents
    # inclusion of that header and breaks FIRStorage* types for Obj-C consumers like RNFBStorage.



    # Ensure gRPC modulemap is present at build time by adding a copy phase to gRPC targets
    begin
      installer.pods_project.targets.each do |t|
        next unless ['gRPC-C++', 'gRPC-Core'].include?(t.name)
        phase_name = '[Workaround] Copy gRPC modulemap'
        exists = t.shell_script_build_phases.any? { |p| p.name == phase_name }
        unless exists
          phase = t.new_shell_script_build_phase(phase_name)
          phase.shell_script = <<-SCRIPT
PODS_ROOT="${PODS_ROOT}"
SRC="${PODS_ROOT}/Target Support Files/gRPC-Core/gRPC-Core.modulemap"
PRIV_DIR="${PODS_ROOT}/Headers/Private/grpc"
PUB_DIR="${PODS_ROOT}/Headers/Public/grpc"
mkdir -p "${PRIV_DIR}" "${PUB_DIR}"
if [ -f "${SRC}" ]; then
  cp -f "${SRC}" "${PRIV_DIR}/gRPC-Core.modulemap" || true
  cp -f "${SRC}" "${PUB_DIR}/gRPC-Core.modulemap" || true
fi
          SCRIPT
          # Ensure it runs early
          t.build_phases.move(phase, 0)
        end
      end
    rescue => e
      Pod::UI.warn("[post_install] Failed to add gRPC modulemap copy phase: #{e.message}")
    end

    # Workaround: React Native 0.75 with modular headers can generate multiple modulemaps
    # that declare `module ReactCommon`, causing "redefinition of module 'ReactCommon'".
    # Rename the module declared in React-RuntimeApple.modulemap to avoid the collision.
    begin
      react_common_headers = File.join(installer.sandbox.root, 'Headers', 'Public', 'ReactCommon')
      rt_apple_mm = File.join(react_common_headers, 'React-RuntimeApple.modulemap')
      if File.exist?(rt_apple_mm)
        content = File.read(rt_apple_mm)
        if content =~ /^\s*module\s+ReactCommon\b/
          new_content = content.sub(/^(\s*)module\s+ReactCommon\b/, "\\1module ReactCommon_RuntimeApple")
          File.write(rt_apple_mm, new_content)
          Pod::UI.puts "[post_install] Renamed module ReactCommon in React-RuntimeApple.modulemap to ReactCommon_RuntimeApple to avoid redefinition".yellow
        end
        # Also ensure this module is not declared as an umbrella module to avoid overlapping umbrellas
        content = File.read(rt_apple_mm)
        modified = false
        if content.include?("umbrella header \"React-RuntimeApple-umbrella.h\"")
          content = content.sub(/umbrella header\s+\"React-RuntimeApple-umbrella.h\"/, 'header "React-RuntimeApple-umbrella.h"')
          modified = true
        end
        # Remove inferred submodules clause which requires an umbrella
        if content =~ /\n\s*module \* \{ export \* \ }/ || content =~ /\n\s*module \* \{ export \* \}/
          content = content.gsub(/\n\s*module \* \{ export \* \ }/, '')
          content = content.gsub(/\n\s*module \* \{ export \* \}/, '')
          modified = true
        end
        if modified
          File.write(rt_apple_mm, content)
          Pod::UI.puts "[post_install] Tweaked React-RuntimeApple.modulemap to use a non-umbrella header and removed inferred submodules".yellow
        end
      end
    rescue => e
      Pod::UI.warn("[post_install] Failed to patch React-RuntimeApple.modulemap: #{e.message}")
    end

    # Remove incorrect weak_framework reference to FirebaseFirestoreInternal (it's a static lib, not a framework)
    begin
      support_root = File.join(installer.sandbox.root, 'Target Support Files')
      %w[Pods-iLeafU Pods-iLeafU-iLeafUTests].each do |agg|
        %w[debug release].each do |cfg|
          xc = File.join(support_root, agg, "#{agg}.#{cfg}.xcconfig")
          next unless File.exist?(xc)
          content = File.read(xc)
          patched = content.gsub(/\s-weak_framework\s+"FirebaseFirestoreInternal"/, '')
          if patched != content
            File.write(xc, patched)
            Pod::UI.puts "[post_install] Removed weak_framework FirebaseFirestoreInternal from #{agg} #{cfg} xcconfig".yellow
          end
        end
      end
    rescue => e
      Pod::UI.warn("[post_install] Failed to remove weak_framework FirebaseFirestoreInternal: #{e.message}")
    end

  # Fix for "unsupported option '-G' for target 'arm64-apple-ios13.4'" error on Apple Silicon Macs
    # Exclude arm64 architecture for iOS simulator builds to avoid compiler flag incompatibilities
    installer.pods_project.build_configurations.each do |config|
      config.build_settings["EXCLUDED_ARCHS[sdk=iphonesimulator*]"] = "arm64"
      # Set "Build Active Architecture Only" to YES to avoid unnecessary architecture builds
      config.build_settings["ONLY_ACTIVE_ARCH"] = "YES"
      # Default C++ standard for all Pods to C++17; specific targets can override to C++20 below.
      config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'c++17'
    end

    # Apply architecture and build settings to all pod targets
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        # Exclude arm64 for iOS simulator at target level
        config.build_settings["EXCLUDED_ARCHS[sdk=iphonesimulator*]"] = "arm64"
        # Set "Build Active Architecture Only" to YES for all configurations
        config.build_settings["ONLY_ACTIVE_ARCH"] = "YES"
        
        # Ensure proper iOS deployment target consistency
        config.build_settings.delete('IPHONEOS_DEPLOYMENT_TARGET')
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '16.0'
      end
    end

    # Remove -G compiler flags from all targets and build configurations (Apple Silicon compatibility)
    begin
      installer.pods_project.targets.each do |target|
        target.build_configurations.each do |config|
          # Remove -G flags from OTHER_CFLAGS
          if config.build_settings['OTHER_CFLAGS']
            flags = config.build_settings['OTHER_CFLAGS']
            if flags.is_a?(Array)
              config.build_settings['OTHER_CFLAGS'] = flags.reject { |flag| flag == '-G' }
            elsif flags.is_a?(String)
              config.build_settings['OTHER_CFLAGS'] = flags.gsub(/\s*-G\s*/, ' ').strip
            end
          end
          
          # Remove -G flags from OTHER_CPLUSPLUSFLAGS
          if config.build_settings['OTHER_CPLUSPLUSFLAGS']
            flags = config.build_settings['OTHER_CPLUSPLUSFLAGS']
            if flags.is_a?(Array)
              config.build_settings['OTHER_CPLUSPLUSFLAGS'] = flags.reject { |flag| flag == '-G' }
            elsif flags.is_a?(String)
              config.build_settings['OTHER_CPLUSPLUSFLAGS'] = flags.gsub(/\s*-G\s*/, ' ').strip
            end
          end
          
          # Remove -G flags from GCC_PREPROCESSOR_DEFINITIONS if present
          if config.build_settings['GCC_PREPROCESSOR_DEFINITIONS']
            defs = config.build_settings['GCC_PREPROCESSOR_DEFINITIONS']
            if defs.is_a?(Array)
              config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] = defs.reject { |definition| definition == '-G' }
            end
          end
        end
      end
      Pod::UI.puts "[post_install] Removed -G compiler flags from all pod targets".yellow
    rescue => e
      Pod::UI.warn("[post_install] Failed to remove -G flags: #{e.message}")
    end

    # Additional cleanup for BoringSSL-GRPC specific issues
    begin
      boring_ssl_target = installer.pods_project.targets.find { |target| target.name == 'BoringSSL-GRPC' }
      if boring_ssl_target
        boring_ssl_target.build_configurations.each do |config|
          # Ensure no -G flags in BoringSSL-GRPC target
          ['OTHER_CFLAGS', 'OTHER_CPLUSPLUSFLAGS', 'WARNING_CFLAGS'].each do |setting|
            if config.build_settings[setting]
              flags = config.build_settings[setting]
              if flags.is_a?(Array)
                config.build_settings[setting] = flags.reject { |flag| flag.include?('-G') }
              elsif flags.is_a?(String)
                config.build_settings[setting] = flags.gsub(/-G\S*/, '').gsub(/\s+/, ' ').strip
              end
            end
          end
        end
        # Also remove problematic per-file compiler flags that can be injected by the podspec
        begin
          boring_ssl_target.source_build_phase.files.each do |file|
            next unless file.settings && file.settings['COMPILER_FLAGS']
            flags = file.settings['COMPILER_FLAGS']
            # Normalize to an array of tokens for safe removal
            tokens = flags.split
            tokens.reject! { |f| f == '-G' || f == '-GCC_WARN_INHIBIT_ALL_WARNINGS' }
            cleaned = tokens.join(' ')
            file.settings['COMPILER_FLAGS'] = cleaned
          end
          Pod::UI.puts "[post_install] Cleaned per-file COMPILER_FLAGS for BoringSSL-GRPC".yellow
        rescue => e
          Pod::UI.warn("[post_install] Failed per-file flag cleanup for BoringSSL-GRPC: #{e.message}")
        end
        Pod::UI.puts "[post_install] Specifically cleaned BoringSSL-GRPC target compiler flags".yellow
      end
    rescue => e
      Pod::UI.warn("[post_install] Failed to clean BoringSSL-GRPC target: #{e.message}")
    end

    # Fix C++20 compatibility for React Native and related Pods (hash_combine/concepts),
    # while keeping gRPC targets on C++17 (gRPC uses std::result_of which is removed in C++20).
    begin
      installer.pods_project.targets.each do |target|
        target.build_configurations.each do |config|
          name = target.name

          # Explicitly prefer C++17 by default
          cxx_standard = 'c++17'

          # Bump to C++20 for React Native targets that use C++20 features (concepts, etc.)
          cpp20_targets = [
            'React-graphics',
            'React-jsi',
            'React-hermes',
            'React-RuntimeCore',
            'React-RuntimeApple',
            'React-cxxreact',
            'React-Fabric',
            'React-FabricComponents',
            'React-FabricImage',
            'React-ImageManager',
            'React-rendererdebug',
            'React-utils',
            'React-debug',
            'jsinspector',
            'Yoga',
          ]
          if cpp20_targets.any? { |t| name.include?(t) }
            cxx_standard = 'c++20'
          end

          # Force C++17 for gRPC and its core deps to keep std::result_of available
          if ['gRPC-Core', 'gRPC-C++', 'abseil'].include?(name)
            cxx_standard = 'c++17'
          end

          config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = cxx_standard
          config.build_settings['CLANG_CXX_LIBRARY'] = 'libc++'
          config.build_settings['CLANG_ENABLE_MODULES'] = 'YES'
          
          # Remove any problematic compiler optimization flags
          config.build_settings.delete('GCC_OPTIMIZATION_LEVEL') if config.build_settings['GCC_OPTIMIZATION_LEVEL'] == '0'
          
          # Remove any debug-specific flags that might conflict with archive builds
          if config.name.downcase.include?('release') || config.name.downcase.include?('archive')
            config.build_settings.delete('ONLY_ACTIVE_ARCH')
            config.build_settings['ONLY_ACTIVE_ARCH'] = 'NO'
          end
        end
      end
      Pod::UI.puts "[post_install] Applied mixed C++ standards: C++20 for RN targets, C++17 for gRPC".yellow
    rescue => e
      Pod::UI.warn("[post_install] Failed to apply C++ compatibility settings: #{e.message}")
    end

  end
end
